"use strict";(self.webpackChunknantralplatform_docs=self.webpackChunknantralplatform_docs||[]).push([[5719],{5741:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>r,default:()=>u,frontMatter:()=>d,metadata:()=>o,toc:()=>l});var a=t(5893),s=t(1151);const d={title:"Backup the database",description:"Instructions on how to backup the production's database"},r="Backups",o={id:"dev/admin/backup-db",title:"Backup the database",description:"Instructions on how to backup the production's database",source:"@site/docs/dev/admin/backup-db.md",sourceDirName:"dev/admin",slug:"/dev/admin/backup-db",permalink:"/dev/admin/backup-db",draft:!1,unlisted:!1,editUrl:"https://github.com/3cn-ecn/nantralPlatform/tree/master/docs/docs/dev/admin/backup-db.md",tags:[],version:"current",lastUpdatedBy:"Alexis Delage",lastUpdatedAt:1706649003,formattedLastUpdatedAt:"Jan 30, 2024",frontMatter:{title:"Backup the database",description:"Instructions on how to backup the production's database"},sidebar:"sidebar",previous:{title:"Administrator Guides",permalink:"/dev/admin/"},next:{title:"Debugging in production",permalink:"/dev/admin/debugging"}},i={},l=[{value:"Automatic Backups",id:"automatic-backups",level:2},{value:"Create and download a backup",id:"create-and-download-a-backup",level:2},{value:"Upload and use a backup",id:"upload-and-use-a-backup",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"backups",children:"Backups"}),"\n",(0,a.jsx)(n.p,{children:"This page is about backups of the database on the server. It requires you to have access to the server and already been connected to the ssh terminal."}),"\n",(0,a.jsx)(n.h2,{id:"automatic-backups",children:"Automatic Backups"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Backups of the database are made every day at 05:00 AM and stored on our S3 bucket."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"They are stored for 30 days. (There is currently nothing to delete them automatically)."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"To make a backup manually:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"cd /home/ubuntu/nantralPlatform/deployment/scripts\nsource env/bin/activate\npython3 db_backup.py\ndeactivate\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"A simple restore script is provided. You need to specify some environment variables first:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"TARGET_DB"}),": the db name to restore"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"TARGET_ARCHIVE"}),": the full path of the archive to restore"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The restore script will delete the TARGET_DB, so make sure you know what you are doing. Then it will create a new one and restore the content from TARGET_ARCHIVE\nIf you specify these environment variable using docker-compose.yml file, then you can execute a restore process like this:\n",(0,a.jsx)(n.code,{children:"docker-compose exec dbbackup ./restore.sh"})]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"create-and-download-a-backup",children:"Create and download a backup"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["CD into the development directory with ",(0,a.jsx)(n.code,{children:"cd nantralPlatform/deployment"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Dump the database with ",(0,a.jsx)(n.code,{children:"docker exec deployment_database_1 pg_dump -U userNameDatabase nantral > dump.sql"}),".\nThis creates a dump.sql file containing all the database's data."]}),"\n",(0,a.jsxs)(n.li,{children:["In order to download the file, run this command in your terminal ",(0,a.jsx)(n.code,{children:"scp -i nantral_platform.pem ubuntu@nantral-platform.fr:~/nantralPlatform/deployment/dump.sql ./dump.sql"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"upload-and-use-a-backup",children:"Upload and use a backup"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Transfer the file to the server by running ",(0,a.jsx)(n.code,{children:"scp -i nantral_platform.pem dump.sql ubuntu@nantral-platform.fr:~/nantralPlatform/deployment/dump.sql"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Transfer the file to the container with ",(0,a.jsx)(n.code,{children:"sudo docker cp dump.sql deployment_database_1:dump.sql"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Open the container's command line with ",(0,a.jsx)(n.code,{children:"sudo docker exec -it deployment_database_1 bin/sh"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Restore from the backup with ",(0,a.jsx)(n.code,{children:"psql -U <username> <dbname> < dump.sql"}),".\nNote that username and dbname are available in the .env file in the deployment directory."]}),"\n",(0,a.jsxs)(n.li,{children:["Delete the dump.sql file using ",(0,a.jsx)(n.code,{children:"rm dump.sql"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Exit the container by running ",(0,a.jsx)(n.code,{children:"exit"})," and delete the dump again with ",(0,a.jsx)(n.code,{children:"rm dump.sql"}),"."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>r});var a=t(7294);const s={},d=a.createContext(s);function r(e){const n=a.useContext(d);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(d.Provider,{value:n},e.children)}}}]);