"use strict";(self.webpackChunknantralplatform_docs=self.webpackChunknantralplatform_docs||[]).push([[10],{8177:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>t,toc:()=>l});var r=o(5893),s=o(1151);const d={sidebar_position:4},c="Docker",t={id:"dev/advanced-guides/docker",title:"Docker",description:"Why using docker on local development?",source:"@site/docs/dev/advanced-guides/docker.md",sourceDirName:"dev/advanced-guides",slug:"/dev/advanced-guides/docker",permalink:"/dev/advanced-guides/docker",draft:!1,unlisted:!1,editUrl:"https://github.com/3cn-ecn/nantralPlatform/tree/master/docs/docs/dev/advanced-guides/docker.md",tags:[],version:"current",lastUpdatedBy:"Alexis Delage",lastUpdatedAt:1706649003,formattedLastUpdatedAt:"Jan 30, 2024",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"sidebar",previous:{title:"Staging Server",permalink:"/dev/advanced-guides/staging-server/"},next:{title:"Manage dependencies",permalink:"/dev/advanced-guides/dependencies"}},i={},l=[{value:"Why using docker on local development?",id:"why-using-docker-on-local-development",level:2},{value:"How to run docker for local dev",id:"how-to-run-docker-for-local-dev",level:2},{value:"Which services are launch?",id:"which-services-are-launch",level:2},{value:"How to run docker for production server",id:"how-to-run-docker-for-production-server",level:2}];function a(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"docker",children:"Docker"}),"\n",(0,r.jsx)(n.h2,{id:"why-using-docker-on-local-development",children:"Why using docker on local development?"}),"\n",(0,r.jsx)(n.p,{children:"Docker is used to manage the code on our server. By using it on your local\nmachine, you will be able to reproduce an environment very close to the\ndeployment one, and so it will be easier to track issues before they appear."}),"\n",(0,r.jsx)(n.p,{children:"In practice, using Docker on your local machine will allow you to:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use the cache system"}),": Django comes with a cachin system, that you can\nonly use with Docker"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use the Postgres database"}),": by default the database uses SQLite, but\nthe deployment database uses postgresql, and so Docker does"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use the celery service"}),": the celery service allow you to run asynchronous\ntasks on the server from the backend"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Uses more debug tools"}),": with Docker, you can for instance access directly\nyour database using PgAdmin for example, or use the Workers Dashboard for\ncelery tasks"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"how-to-run-docker-for-local-dev",children:"How to run docker for local dev"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Install docker-desktop from the official website:\n",(0,r.jsx)(n.a,{href:"https://docs.docker.com/get-docker/",children:"docs.docker.com/get-docker"})]}),"\n",(0,r.jsxs)(n.li,{children:["Add the ",(0,r.jsx)(n.em,{children:'"docker needed"'})," variables in your ",(0,r.jsx)(n.code,{children:".env"})," environment file.\nIt must be at this place: ",(0,r.jsx)(n.code,{children:"backend/config/settings/.env"})]}),"\n",(0,r.jsxs)(n.li,{children:["Go to the ",(0,r.jsx)(n.code,{children:"deployment"})," directory: ",(0,r.jsx)(n.code,{children:"cd deployment/"})]}),"\n",(0,r.jsxs)(n.li,{children:["Create an empty file ",(0,r.jsx)(n.code,{children:"backend.env"})," in this directory"]}),"\n",(0,r.jsxs)(n.li,{children:["Build the containers: ",(0,r.jsx)(n.code,{children:"docker-compose build"})]}),"\n",(0,r.jsxs)(n.li,{children:["Start the services: ",(0,r.jsx)(n.code,{children:"docker-compose up"})]}),"\n",(0,r.jsxs)(n.li,{children:["Try to connect to ",(0,r.jsx)(n.code,{children:"http://localhost"})," in your browser."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"If you can access the login page, congratulations everything is ok! \ud83e\udd73"}),"\n",(0,r.jsxs)(n.p,{children:["Let's create a superuser account now, so that you can connect. For this, follow the\ntutorial ",(0,r.jsx)(n.a,{href:"/dev/get-started/setup-project/#create-your-account",children:"here"}),". You only have to replace\nthe command for creating a superuser by:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker-compose exec backend python3 manage.py createsuperuser\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can run this command in another terminal (but always in the ",(0,r.jsx)(n.code,{children:"deployment"})," directory)."]}),"\n",(0,r.jsx)(n.admonition,{title:"Useful tips",type:"success",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["You can stop docker by pressing ",(0,r.jsx)("kbd",{children:"CTRL"}),"+",(0,r.jsx)("kbd",{children:"C"})," in the console if docker\nis running, or by running the command ",(0,r.jsx)(n.code,{children:"docker-compose down"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["You can also launch docker services in background by adding the\n",(0,r.jsx)(n.code,{children:"-d"})," argument on the up command."]}),"\n",(0,r.jsxs)(n.li,{children:["If you want to be faster, you can run both command at once by\nusing ",(0,r.jsx)(n.code,{children:"docker-compose up --build"})]}),"\n"]})}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{children:(0,r.jsx)(n.strong,{children:"What does it do?"})}),(0,r.jsxs)(n.p,{children:["When you run ",(0,r.jsx)(n.code,{children:"docker-compose"})," without specifying the files to run, it\nruns by default ",(0,r.jsx)(n.code,{children:"docker-compose.yml"})," and then ",(0,r.jsx)(n.code,{children:"docker-compose.override.yml"}),".\nIt is equivalent to run:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker-compose -f docker-compose.yml -f docker-compose.override.yml up --build\n"})}),(0,r.jsx)(n.p,{children:"In our case, the files are configured to run the backend (with django),\nan instance of postgresql (the database), and the celery services (for\nbackground tasks)."})]}),"\n",(0,r.jsx)(n.h2,{id:"which-services-are-launch",children:"Which services are launch?"}),"\n",(0,r.jsx)(n.p,{children:"These services are launch when you run Docker on your local machine:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Service"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Access"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"database"}),(0,r.jsx)(n.td,{children:"The postgresql database for the website"}),(0,r.jsxs)(n.td,{children:["You can read it by connecting to the port 5432 on localhost with ",(0,r.jsx)(n.a,{href:"https://www.pgadmin.org/download/",children:"PgAdmin4"}),", and using the credentials defined in your ",(0,r.jsx)(n.code,{children:".env"})," file"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"backend"}),(0,r.jsx)(n.td,{children:"The django server which serve files"}),(0,r.jsxs)(n.td,{children:["Open ",(0,r.jsx)(n.a,{href:"http://localhost",children:"http://localhost"})," in your browser"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"nginx"}),(0,r.jsx)(n.td,{children:"Used to serve the backend and the static files"}),(0,r.jsx)(n.td,{children:"-"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"redis"}),(0,r.jsx)(n.td,{children:"Used for the django cache system"}),(0,r.jsx)(n.td,{children:"-"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"celery"}),(0,r.jsx)(n.td,{children:"Used for asynchronous tasks runned in background"}),(0,r.jsx)(n.td,{children:"-"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"celery-beat"}),(0,r.jsx)(n.td,{children:"Used for linking celery to the backend with django"}),(0,r.jsx)(n.td,{children:"-"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"workers-dashboard"}),(0,r.jsx)(n.td,{children:"A dashboard to see all the celery tasks"}),(0,r.jsxs)(n.td,{children:["Open ",(0,r.jsx)(n.a,{href:"http://localhost:5555",children:"http://localhost:5555"})," in your browser"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"mailpit"}),(0,r.jsx)(n.td,{children:"An email server to show emails sent by django in local"}),(0,r.jsxs)(n.td,{children:["Open ",(0,r.jsx)(n.a,{href:"http://localhost:8025",children:"http://localhost:8025"})," in your browser"]})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"how-to-run-docker-for-production-server",children:"How to run docker for production server"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Go to the ",(0,r.jsx)(n.code,{children:"deployment"})," directory."]}),"\n",(0,r.jsxs)(n.li,{children:["Create the environment files at the root of this directory:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"backend.env"})," for all environment variables related to django"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"mailu.env"})," for those related to the mail server"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"frontend.env"})," for those related to the react frontend"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Build and run the docker-compose files:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --build -d\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{type:"info",children:[(0,r.jsx)(n.p,{children:"Note that in practice, we will not stop and restart all services each\ntime we want to make an update. To do so, we can indicate which service\nwe want to restart. For example, to restart only the backend:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache nginx backend\ndocker-compose -f docker-compose.yml -f docker-compose.prod.yml up\n"})}),(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"--no-cache"})," option allowed to delete the cache and be sure that\nall files are really updated."]})]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},1151:(e,n,o)=>{o.d(n,{Z:()=>t,a:()=>c});var r=o(7294);const s={},d=r.createContext(s);function c(e){const n=r.useContext(d);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),r.createElement(d.Provider,{value:n},e.children)}}}]);