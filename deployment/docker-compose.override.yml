version: "2.1"

services:
  database:
    env_file: ../server/config/settings/.env
  
  server:
    env_file: ../server/config/settings/.env
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.docker

  # External dependencies
  
  nginx:
    build: ./containers/nginx_http
  
  celery:
    env_file: ../server/config/settings/.env
  
  celery-beat:
    env_file: ../server/config/settings/.env

  workers-dashboard:
    build:
      context: ../
      dockerfile: deployment/containers/web/Dockerfile
    command: celery -A apps.celery --broker=redis://redis:6379/0 flower --port=5555
    ports:
      - 5555:5555
    depends_on:
      - server
      - redis
      - celery
    env_file: ../server/config/settings/.env
    environment:
      - CELERY_BROKER=redis://redis:6379/0
      - CELERY_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=config.settings.docker
